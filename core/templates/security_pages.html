{% extends "base_account.html" %}
{% load user_sessions %}
{% load i18n %}
{% load Pleio_templatetags %}

{% block content %}

<!-- Password reset -->
<h2>{% trans "Security" %}</h2>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<div class="account__cards">
    
    <div class="card ___nopadding">
        <h2 class="card__title ___addpadding-side">{% trans "Reset password" %}</h2>
        
        <form method="post" action=".">
            <input type="hidden" name="page_action" value="ChangePassword" />
                
            <div class="___addpadding-side">
                {% csrf_token %} 
                
                <fieldset>
                    <ul class="messages error">
                        {% for error in pass_reset_form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    
                    <div class="input-field">
                        <label for="id_old_password">{% trans "Current Password" %}</label>
                        {{ pass_reset_form.errors.old_password }}
                        {{ pass_reset_form.old_password }}
                        <span class="password__toggle">{% include_asset "icons/eye.svg" %}</span>            
                    </div>
                    
                    <div class="input-field">
                        <label for="id_new_password1">{% trans "New Password" %}</label>
                        {{ pass_reset_form.errors.new_password1 }}
                        {{ pass_reset_form.new_password1 }}
                        <span class="password__toggle">{% include_asset "icons/eye.svg" %}</span>            
                    </div>
                    
                    <div class="input-field">
                        <label for="id_new_password2">{% trans "New Password (again)" %}</label>
                        {{ pass_reset_form.errors.new_password2 }}
                        {{ pass_reset_form.new_password2 }}
                        <span class="password__toggle">{% include_asset "icons/eye.svg" %}</span>
                    </div>
                    
                </fieldset>
            </div>
            
            <div class="card__action ___addpadding-side">
                <button class="button ___active ___clear" type="submit">{% trans "Confirm" %}</button>
            </div>
        </form>
    </div>
</div>


<!-- Two factor authorization -->
<h2>{% block title %}{% trans "Two-Factor Authentication" %}{% endblock %}</h2>
<div class="account__cards">
    
    {% if 2FA.state == 'default' %}
        {% if 2FA.default_device %}
            <div class="card ___nopadding">
                <h2 class="card__title ___addpadding-side">{% trans "Backup Tokens" %}</h2>
                <p class="___addpadding-side">
                    {% trans "Tokens will be generated by your token generator." %}<br /><br />
                    {% blocktrans %}If you don't have any device with you, you can access
                    your account using backup tokens.{% endblocktrans %}
                    {% blocktrans count counter=2FA.backup_tokens %}
                    You have only one backup token remaining.
                    {% plural %}
                    You have {{ counter }} backup tokens remaining.
                    {% endblocktrans %}
                </p>
                <div class="card__action ___addpadding-side">
                    <a href="{% url 'security_pages' page_action='2FAShowCodes' %}" class="button ___clear">{% trans "Show Codes" %}</a>
                </div>
            </div>
        {% endif %}
    {% endif %}
    
    {% if 2FA.state == 'setup' %}
        <div class="account__cards">
            <div class="card ___nopadding">
                <form method="post" action=".">
                    <input type="hidden" name="page_action" value="2FASetUpNext" />
                    {% csrf_token %}
                    <h2 class="card__title ___addpadding-side">{% trans "Enable Two-factor Authentication" %}</h2>
                    <fieldset class="___addpadding-side">
                        <p>{% blocktrans %}Scan the QR-code below with your token generator and enter the generated token.{% endblocktrans %}</p>
                        <p>
                            <center>
                                <img src="{{ 2FA.QR_URL }}" alt="QR Code" />
                            </center>
                        </p>
                        <br />
                        <div class="input-field">
                            {{ 2FA.form.errors.token }}
                            {{ 2FA.form.token.label_tag }}
                            {{ 2FA.form.token }}
                        </div>
                        
                        <p class="textcolor_secondary">
                            {% blocktrans %}Don't have a token generator? Try <a href="https://support.google.com/accounts/answer/1066447" target="_blank" rel="nofollow">Google Authenticator</a> or <a href="https://authy.com/download/" target="_blank" rel="nofollow">Authy</a>.{% endblocktrans %}
                        </p>
                    </fieldset>
                    <div class="card__action ___addpadding-side">
                        <button name="volgende" class="button  ___active ___clear login__login" type="submit">{% trans "Next" %}</button>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}

    {% if 2FA.state == 'codes' %}
        <form method="post">{% csrf_token %}{{ form }}
            <input type="hidden" name="page_action" value="2FAGenerateCodes" />
                
            <div class="account__cards">
                <div class="card ___nopadding">
                <h2 class="card__title ___addpadding-side">{% trans "Backup Tokens" %}</h2>
                <div class="___addpadding-side">
                    <p>{% blocktrans %}Backup tokens can be used when your primary and backup
                        phone numbers aren't available. The backup tokens below can be used
                        for login verification. If you've used up all your backup tokens, you
                        can generate a new set of backup tokens. Only the backup tokens shown
                        below will be valid.{% endblocktrans %}</p>
                        {% if 2FA.tokens.count %}
                        <ul class="___inline">
                            {% for token in 2FA.tokens %}
                            <li>
                                <span class="badge ___tag grey">{{ token.token }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        <br />
                        <p>{% blocktrans %}Print these tokens and keep them somewhere safe.{% endblocktrans %}</p>
                        {% else %}
                        <p>{% trans "You don't have any backup codes yet." %}</p>
                        {% endif %}
                    </div>
                    <div class="card__action ___addpadding-side">
                        <button class="button ___clear" type="submit">{% trans "Generate Tokens" %}</button>
                    </div>
                </div>
            </div>
        </form>
    {% endif %}

    {% if 2FA.state == 'disable' %}
        <div class="account__cards">
            <div class="card ___nopadding">
                <form method="post">
                    <input type="hidden" name="page_action" value="2FADisableConfirm" />
                    {% csrf_token %}
                    <h2 class="card__title ___addpadding-side">{% trans "Disable Two-factor Authentication" %}</h2>
                    <fieldset class="___addpadding-side">
                        <p>{% blocktrans %}You are about to disable two-factor authentication. This
                        compromises your account security, are you sure?{% endblocktrans %}</p>
                        <div class="login__check">
                          <input id="id_understand" name="understand" type="checkbox" required="">
                          <label for="id_understand">{% trans "Yes, I am sure" %}</label>
                        </div>
                    </fieldset>
                    <div class="card__action ___addpadding-side">
                        <button class="button ___clear" type="submit">{% trans "Disable" %}</button>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}

    {% if 2FA.show_state %}
        <div class="card ___nopadding">
            {% if 2FA.default_device %}
                <h2 class="card__title ___addpadding-side">{% trans "Disable Two-Factor Authentication" %}</h2>
                <div class="___addpadding-side">
                    <div class="image__2fa __disable">
                        {% include_asset "images/2fa.svg" %}
                    </div>
                    {% blocktrans %}However we strongly discourage you to do so, you can
                    also disable two-factor authentication for your account.{% endblocktrans %}
                </div>
                <div class="card__action ___addpadding-side">
                    <a href="{% url 'security_pages' page_action='2FADisable' %}" class="button ___clear">{% trans "Disable" %}</a>
                </div>
            {% else %}
                <h2 class="card__title ___addpadding-side">{% trans "Enable Two-Factor Authentication" %}</h2>
                <div class="___addpadding-side">
                    <div class="image__2fa __enable">
                        {% include_asset "images/2fa.svg" %}
                    </div>
                    {% blocktrans %}Two-factor authentication is not enabled for your
                        account. Enable two-factor authentication for enhanced account
                        security.{% endblocktrans %}
                </div>
                <form method="post" action=".">
                        <input type="hidden" name="page_action" value="2FASetUp" />
                        {% csrf_token %}
                        <button type="submit" class="button __stretch ___clear">{% trans "Enable" %}</button>
                </form>
            {% endif %}
        </div>
    {% endif %}
    
</div>

<!-- User sessions -->
    <h2>{% trans "Active Sessions" %}</h2>
    
    <div class="account__cards">
        <div class="card ___stretch ___nopadding">
            <h2 class="card__title ___addpadding-side">{% trans "Signed in devices" %}</h2>
            <fieldset class="___addpadding-side">
                {% trans "unknown on unknown" as unknown_on_unknown %}
                {% trans "unknown" as unknown %}

                <table class="table ___stretch">
                    <thead>
                        <tr>
                            <th>{% trans "Device" %}</th>
                            <th>{% trans "Location" %}</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for object in object_list %}
                        <tr>
                            <td>{{ object.user_agent|device|default_if_none:unknown_on_unknown|safe }}</td>
                            <td title="{{ object.ip }}">
                                {{ object.ip|location|default_if_none:unknown|safe }}
                                <small class="textcolor_secondary">
                                    &ndash;
                                    {% if object.session_key == session_key %}
                                    <span class="green-text">{% trans "this session" %}</span>
                                    {% else %}
                                    {% blocktrans with time=object.last_activity|timesince %}{{ time }} ago{% endblocktrans %}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <form method="post" action="{% url 'session_delete' object.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="button __stretch ___clear">{% trans "Logout" %}</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <br />
        
            </fieldset>
            
            {% if object_list.count > 1 %}
            <div class="card__action ___addpadding-side">
                <form method="post" action="{% url 'session_delete_other' %}">
                    {% csrf_token %}
                    <button type="submit" class="button ___clear">{% trans "End All Other Sessions" %}</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

{% endblock %}
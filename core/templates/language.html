
{% load i18n %}

{% comment %}
<a href="{{ current_path }}" class="ui primary button compact" onclick="changeLanguage();" id='btn' title="{% trans "Change language" %}">
        {% get_current_language as LANGUAGE_CODE %}
        {% get_available_languages as LANGUAGES %}
        {% for langs in LANGUAGES %}
            <span>{{ langs.0 }}</span> </br>
        {% endfor %}
      {% if request.COOKIES.lang == 'en'%}
        <span aria-hidden="true">FR</span>
        <span class="invisible" lang="fr">Fran√ßais</span>
      {% else %}
        <span aria-hidden="true">EN</span>
        <span class="invisible" lang="en">English</span>
      {% endif %}
    </a>
{% endcomment %}
    <div class="">
        <form name="ui" action="{% url 'set_language' %}" method="post">{% csrf_token %}
            <input name="next" type="hidden" value="{{ redirect_to }}" />
            <input name="language" type="hidden"/>
            {% get_current_language as LANGUAGE_CODE %}
            {% get_language_info for LANGUAGE_CODE as lang %}
            {% get_available_languages as LANGUAGES %}
            {% get_language_info_list for LANGUAGES as languages %}
            {% if LANGUAGES|length < 3 %}
                {% for language in languages %}
                    {% if langs.0 != LANGUAGE_CODE %}
                        <a href="{{ current_path }}" class="ui primary button compact" onclick="document.ui.language.value='{{ language.code}}'; document.ui.submit();" id='btn' title="{% trans "Change language" %}">
                            <span>{{ langs.0|upper }}</span>
                        </a> 
                    {% endif %}   
                {% endfor %}
            {% else %}
                <div class="ui dropdown item">
                    {{ lang.name_local }}
                    <i class="dropdown icon"></i>
                    <div class="menu" title="{% trans "Change language" %}">
                        {% for language in languages %}
                            <a href="#" class="item" onclick="document.ui.language.value='{{ language.code}}'; document.ui.submit();">{{ language.name_local }}</a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </form>
    </div>

<script>

function changeLanguage(lang) {
    console.log('my lang'+lang);
    $.ajax({
        type: "POST",
        url: "{% url 'set_language' %}",
        data: {'language': lang, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success: function(response) {
            setLangCookie(lang);
            console.log('set cookie '+lang);
        },
        error: function(rs, e) { console.log(e); }
    });    
}    
function getCookie(cname) {
    var lang = "";
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            //return c.substring(name.length, c.length);
            lang = c.substring(name.length, c.length);
        }
    }
    return lang;
}

function setLangCookie(lang) {
    var hostname = location.hostname;
    var length = hostname.split(".").length - 1;
    var domain = (length >= 2) ? '.' + hostname.split('.').slice(-2).join('.') : hostname;
    setCookie("lang", lang, '', '/', domain);
}

function setCookie(sName, sValue, oExpires, sPath, sDomain, bSecure) {
    var sCookie = sName + "=" + encodeURIComponent(sValue);
    if (oExpires) {
        sCookie += "; expires=" + oExpires.toGMTString();
    }
    if (sPath) {
        sCookie += "; path=" + sPath;
    }
    if (sDomain) {
        sCookie += "; domain=" + sDomain;
    }
    if (bSecure) {
        sCookie += "; secure";
    }
    document.cookie = sCookie;

    $.ajax({
        type: "POST",
        url: "{% url 'set_language' %}",
        data: {'language': sValue, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success: function(response) {},
        error: function(rs, e) { console.log(e); }
    });

}
</script>
